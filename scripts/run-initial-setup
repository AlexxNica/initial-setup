#!/bin/bash

IS_TEXT="/usr/libexec/initial-setup/initial-setup-text"
IS_GRAPHICAL="/usr/libexec/initial-setup/initial-setup-graphical"
IS_UNIT=initial-setup.service

WINDOWMANAGER_SCRIPT="/usr/libexec/initial-setup/firstboot-windowmanager"

START_GUI_COMMAND="/bin/xinit ${WINDOWMANAGER_SCRIPT} ${IS_GRAPHICAL} --no-stdout-log -- /bin/Xorg :9 -ac -nolisten tcp"

# check if graphical Initial Setup is installed
if [ -f ${IS_GRAPHICAL} ]; then
    echo "Starting Initial Setup GUI" | systemd-cat -t initial-setup -p 6
    ${START_GUI_COMMAND}
else
    echo "Starting Initial Setup TUI" | systemd-cat -t initial-setup -p 6
    ${IS_TEXT} --no-stdout-log
fi

# check if the Initial Setup run was successfull by looking at the return code
if [ $? -eq 0 ]; then
    echo "Initial Setup finished successfully, disabling" | systemd-cat -t initial-setup -p 6
    /bin/systemctl disable initial-setup.service &>/dev/null
    echo "Initial Setup has been disabled" | systemd-cat -t initial-setup -p 6
else
    echo "Initial Setup failed, keeping enabled" | systemd-cat -t initial-setup -p 3
fi
